// ===========================================
// Prisma Schema - Sistema de Restaurantes
// Version Completa con todos los modelos
// ===========================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ===========================================
// RESTAURANTES
// ===========================================

model Restaurant {
  id            String   @id @default(uuid())
  name          String   @db.VarChar(255)
  slug          String   @unique @db.VarChar(255)
  description   String?  @db.Text
  phone         String?  @db.VarChar(20)
  email         String?  @db.VarChar(255)
  website       String?  @db.VarChar(255)
  logoUrl       String?  @map("logo_url") @db.VarChar(500)
  coverImageUrl String?  @map("cover_image_url") @db.VarChar(500)
  rating        Decimal  @default(0.00) @db.Decimal(3, 2)
  priceRange    String?  @map("price_range") @db.VarChar(10)
  isActive      Boolean  @default(true) @map("is_active")
  openingYear   Int?     @map("opening_year")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relaciones
  categories   RestaurantCategory[]
  addresses    Address[]
  schedules    Schedule[]
  menus        Menu[]
  products     Product[]
  tables       Table[]
  reservations Reservation[]
  orders       Order[]
  reviews      Review[]

  @@index([slug])
  @@index([rating])
  @@index([isActive])
  @@map("restaurants")
}

// ===========================================
// CATEGORIAS
// ===========================================

model Category {
  id          String   @id @default(uuid())
  name        String   @unique @db.VarChar(100)
  slug        String   @unique @db.VarChar(100)
  description String?  @db.Text
  iconUrl     String?  @map("icon_url") @db.VarChar(500)
  createdAt   DateTime @default(now()) @map("created_at")

  // Relaciones
  restaurants RestaurantCategory[]

  @@index([slug])
  @@map("categories")
}

// Relacion muchos a muchos Restaurant-Category
model RestaurantCategory {
  restaurantId String   @map("restaurant_id")
  categoryId   String   @map("category_id")
  isPrimary    Boolean  @default(false) @map("is_primary")
  createdAt    DateTime @default(now()) @map("created_at")

  restaurant Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  category   Category   @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@id([restaurantId, categoryId])
  @@index([restaurantId])
  @@index([categoryId])
  @@map("restaurant_categories")
}

// ===========================================
// DIRECCIONES
// ===========================================

model Address {
  id            String   @id @default(uuid())
  restaurantId  String   @map("restaurant_id")
  streetAddress String   @map("street_address") @db.VarChar(255)
  city          String   @db.VarChar(100)
  stateProvince String   @map("state_province") @db.VarChar(100)
  postalCode    String   @map("postal_code") @db.VarChar(20)
  country       String   @default("Mexico") @db.VarChar(100)
  latitude      Decimal? @db.Decimal(10, 8)
  longitude     Decimal? @db.Decimal(11, 8)
  isMain        Boolean  @default(true) @map("is_main")
  createdAt     DateTime @default(now()) @map("created_at")

  restaurant Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  @@index([restaurantId])
  @@index([city])
  @@map("addresses")
}

// ===========================================
// HORARIOS DE OPERACION
// ===========================================

model Schedule {
  id           String   @id @default(uuid())
  restaurantId String   @map("restaurant_id")
  dayOfWeek    Int      @map("day_of_week") // 0=Domingo, 6=Sabado
  openTime     String?  @map("open_time") @db.VarChar(8)
  closeTime    String?  @map("close_time") @db.VarChar(8)
  isClosed     Boolean  @default(false) @map("is_closed")
  createdAt    DateTime @default(now()) @map("created_at")

  restaurant Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  @@unique([restaurantId, dayOfWeek])
  @@index([restaurantId])
  @@map("schedules")
}

// ===========================================
// USUARIOS
// ===========================================

model User {
  id           String    @id @default(uuid())
  email        String    @unique @db.VarChar(255)
  passwordHash String    @map("password_hash") @db.VarChar(255)
  firstName    String    @map("first_name") @db.VarChar(100)
  lastName     String    @map("last_name") @db.VarChar(100)
  phone        String?   @db.VarChar(20)
  avatarUrl    String?   @map("avatar_url") @db.VarChar(500)
  dateOfBirth  DateTime? @map("date_of_birth") @db.Date
  isActive     Boolean   @default(true) @map("is_active")
  isVerified   Boolean   @default(false) @map("is_verified")
  role         String    @default("customer") @db.VarChar(20)
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")
  lastLogin    DateTime? @map("last_login")

  // Relaciones
  reservations Reservation[]
  orders       Order[]
  reviews      Review[]

  @@index([email])
  @@index([role])
  @@map("users")
}

// ===========================================
// MENUS
// ===========================================

model Menu {
  id           String   @id @default(uuid())
  restaurantId String   @map("restaurant_id")
  name         String   @db.VarChar(255)
  description  String?  @db.Text
  isActive     Boolean  @default(true) @map("is_active")
  displayOrder Int      @default(0) @map("display_order")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  restaurant Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  @@index([restaurantId])
  @@index([isActive])
  @@map("menus")
}

// ===========================================
// PRODUCTOS (platillos/items)
// ===========================================

model Product {
  id           String   @id @default(uuid())
  restaurantId String   @map("restaurant_id")
  name         String   @db.VarChar(255)
  description  String?  @db.Text
  price        Decimal  @db.Decimal(10, 2)
  imageUrl     String?  @map("image_url") @db.VarChar(500)
  category     String?  @db.VarChar(100) // entrada, plato fuerte, postre, bebida
  isAvailable  Boolean  @default(true) @map("is_available")
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  restaurant Restaurant  @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  orderItems OrderItem[]

  @@index([restaurantId])
  @@index([isAvailable])
  @@index([category])
  @@map("products")
}

// ===========================================
// MESAS
// ===========================================

model Table {
  id           String   @id @default(uuid())
  restaurantId String   @map("restaurant_id")
  tableNumber  String   @map("table_number") @db.VarChar(20)
  capacity     Int
  location     String?  @db.VarChar(100) // Terraza, Interior, VIP
  isAvailable  Boolean  @default(true) @map("is_available")
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  restaurant   Restaurant    @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  reservations Reservation[]
  orders       Order[]

  @@unique([restaurantId, tableNumber])
  @@index([restaurantId])
  @@index([isAvailable])
  @@map("tables")
}

// ===========================================
// RESERVACIONES
// ===========================================

model Reservation {
  id              String    @id @default(uuid())
  restaurantId    String    @map("restaurant_id")
  userId          String?   @map("user_id")
  tableId         String?   @map("table_id")
  guestName       String    @map("guest_name") @db.VarChar(255)
  guestEmail      String    @map("guest_email") @db.VarChar(255)
  guestPhone      String    @map("guest_phone") @db.VarChar(20)
  partySize       Int       @map("party_size")
  reservationDate DateTime  @map("reservation_date") @db.Date
  reservationTime String    @map("reservation_time") @db.VarChar(8)
  status          String    @default("pending") @db.VarChar(20) // pending, confirmed, cancelled, completed
  specialRequests String?   @map("special_requests") @db.Text
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  restaurant Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  user       User?      @relation(fields: [userId], references: [id], onDelete: SetNull)
  table      Table?     @relation(fields: [tableId], references: [id], onDelete: SetNull)

  @@index([restaurantId])
  @@index([userId])
  @@index([tableId])
  @@index([reservationDate])
  @@index([status])
  @@map("reservations")
}

// ===========================================
// PEDIDOS
// ===========================================

model Order {
  id           String    @id @default(uuid())
  restaurantId String    @map("restaurant_id")
  userId       String?   @map("user_id")
  tableId      String?   @map("table_id")
  orderNumber  String    @unique @map("order_number") @db.VarChar(20)
  status       String    @default("pending") @db.VarChar(20) // pending, preparing, ready, delivered, cancelled
  subtotal     Decimal   @db.Decimal(10, 2)
  tax          Decimal   @default(0) @db.Decimal(10, 2)
  total        Decimal   @db.Decimal(10, 2)
  notes        String?   @db.Text
  paidAt       DateTime? @map("paid_at")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  restaurant Restaurant  @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  user       User?       @relation(fields: [userId], references: [id], onDelete: SetNull)
  table      Table?      @relation(fields: [tableId], references: [id], onDelete: SetNull)
  items      OrderItem[]

  @@index([restaurantId])
  @@index([userId])
  @@index([tableId])
  @@index([status])
  @@index([createdAt])
  @@map("orders")
}

model OrderItem {
  id        String   @id @default(uuid())
  orderId   String   @map("order_id")
  productId String   @map("product_id")
  quantity  Int      @default(1)
  unitPrice Decimal  @map("unit_price") @db.Decimal(10, 2)
  subtotal  Decimal  @db.Decimal(10, 2)
  notes     String?  @db.VarChar(255)
  createdAt DateTime @default(now()) @map("created_at")

  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([productId])
  @@map("order_items")
}

// ===========================================
// RESENAS / VALORACIONES
// ===========================================

model Review {
  id           String    @id @default(uuid())
  restaurantId String    @map("restaurant_id")
  userId       String    @map("user_id")
  rating       Int       // 1-5
  title        String?   @db.VarChar(255)
  comment      String?   @db.Text
  visitDate    DateTime? @map("visit_date") @db.Date
  isVisible    Boolean   @default(true) @map("is_visible")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  restaurant Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([restaurantId, userId])
  @@index([restaurantId])
  @@index([userId])
  @@index([rating])
  @@map("reviews")
}
